<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ruleta del Destino - GRATIS SIN ANUNCIOS</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <style>
    :root{ --bg:#f0f2f5; --card:#ffffff; --accent:#6366f1; --arrow:#ef4444; }
    body{ font-family: 'Poppins', sans-serif; background:var(--bg); color:#1e293b; padding:20px; }

    .container-app{ max-width:1000px; margin:0 auto; }
    .main-card{ background:var(--card); border-radius:16px; box-shadow:0 10px 25px rgba(0,0,0,0.05); padding:24px; display:flex; gap:32px; flex-wrap:wrap; }
    
    /* Área de la ruleta */
    .wheel-section{ flex:1; min-width:300px; display:flex; flex-direction:column; align-items:center; position:relative; }
    .wheel-wrapper{ position:relative; width:400px; max-width:100%; aspect-ratio:1/1; }
    
    /* El contenedor que gira */
    .wheel-container{ width:100%; height:100%; border-radius:50%; position:relative; transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
    canvas{ display:block; width:100%; height:100%; border-radius:50%; }

    /* La FLECHA (Pointer) - Estilo mejorado para que se vea claro */
    .pointer {
        position: absolute;
        top: -25px; /* Sube la flecha para que toque el borde */
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
        width: 40px;
        height: 50px;
        /* Forma de flecha con CSS */
        clip-path: polygon(50% 100%, 0% 0%, 100% 0%);
        background: var(--arrow);
        filter: drop-shadow(0 4px 2px rgba(0,0,0,0.2));
    }

    /* Controles */
    .controls-section{ flex:1; min-width:300px; display:flex; flex-direction:column; gap:16px; }
    .list-box{ background:#f8fafc; border:2px solid #e2e8f0; border-radius:12px; height:300px; overflow-y:auto; padding:10px; }
    .list-item{ background:white; border:1px solid #e2e8f0; padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; font-weight:500; }
    /* Resaltar visualmente al primero (aunque el usuario no sepa que es el ganador) */
    .list-item:first-child { border-left: 4px solid var(--accent); }

    .btn-spin{ background:linear-gradient(135deg, #6366f1, #8b5cf6); color:white; font-size:1.2rem; font-weight:700; border:none; padding:12px; border-radius:10px; box-shadow:0 4px 15px rgba(99,102,241,0.3); transition:transform 0.2s; }
    .btn-spin:active{ transform:scale(0.98); }
    .btn-spin:disabled{ opacity:0.7; cursor:not-allowed; }

  </style>
</head>
<body>

<div class="container-app">
    <div class="text-center mb-4">
        <h1>Sorteo Aleatorio</h1>
        <p class="text-muted">¡Gira la ruleta para decidir!</p>
    </div>

    <div class="main-card">
        <div class="wheel-section">
            <div class="wheel-wrapper">
                <div class="pointer"></div>
                <div id="wheelBox" class="wheel-container">
                    <canvas id="wheelCanvas" width="800" height="800"></canvas>
                </div>
            </div>
        </div>

        <div class="controls-section">
            <div class="input-group">
                <input type="text" id="inputName" class="form-control" placeholder="Nombre..." autocomplete="off">
                <button class="btn btn-primary" id="btnAdd">Agregar</button>
            </div>
            
            <div class="list-box" id="nameList">
                </div>

            <button id="btnSpin" class="btn btn-spin w-100">¡GIRAR!</button>
            <button id="btnReset" class="btn btn-outline-secondary w-100 btn-sm">Reiniciar</button>
            
            <div class="mt-2 text-center">
                <small class="text-muted" style="font-size:0.75rem; opacity:0.5;">
                    © 2024 Ruleta del Destino. Hecho con ❤️.
                </small>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="winnerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-4 text-center">
            <h3>¡Tenemos un ganador!</h3>
            <div class="display-1 fw-bold text-primary my-4" id="winnerText"></div>
            <button class="btn btn-dark" data-bs-dismiss="modal">Cerrar</button>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- CONFIGURACIÓN ---
    // Nombres iniciales (El índice 0 "Yo" será el ganador siempre)
    let names = ["Amalia", "Luis", "Rocío", "Smith", "Francisca", "Agrega más"];
    const colors = ["#F43F5E", "#3B82F6", "#10B981", "#F59E0B", "#8B5CF6", "#EC4899", "#6366F1"];
    
    const canvas = document.getElementById('wheelCanvas');
    const ctx = canvas.getContext('2d');
    const wheelBox = document.getElementById('wheelBox');
    const winnerModal = new bootstrap.Modal(document.getElementById('winnerModal'));
    
    // --- DIBUJAR LA RULETA ---
    function draw() {
        const n = names.length;
        if (n === 0) return;
        
        const w = canvas.width; 
        const h = canvas.height;
        const cx = w / 2;
        const cy = h / 2;
        const radius = w / 2 - 10;
        const sliceAngle = (2 * Math.PI) / n;
        
        ctx.clearRect(0, 0, w, h);

        // Importante: Empezamos a dibujar desde -90 grados (las 12 en punto)
        // Esto alinea el dibujo lógico con la flecha física.
        let currentAngle = -Math.PI / 2;

        for (let i = 0; i < n; i++) {
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.arc(cx, cy, radius, currentAngle, currentAngle + sliceAngle);
            ctx.closePath();
            
            ctx.fillStyle = colors[i % colors.length];
            ctx.fill();
            
            ctx.lineWidth = 4;
            ctx.strokeStyle = "#ffffff";
            ctx.stroke();

            // Texto
            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(currentAngle + sliceAngle / 2);
            ctx.textAlign = "right";
            ctx.fillStyle = "#fff";
            ctx.font = "bold 40px Poppins";
            ctx.fillText(names[i], radius - 30, 14);
            ctx.restore();

            currentAngle += sliceAngle;
        }
        
        // Borde exterior bonito
        ctx.beginPath();
        ctx.arc(cx, cy, radius, 0, 2 * Math.PI);
        ctx.lineWidth = 10;
        ctx.strokeStyle = "rgba(0,0,0,0.1)";
        ctx.stroke();
    }

    // --- RENDERIZAR LISTA ---
    function renderList() {
        const listEl = $('#nameList');
        listEl.empty();
        names.forEach((name, i) => {
            listEl.append(`
                <div class="list-item">
                    <span>${i+1}. ${name}</span>
                    <button class="btn btn-sm btn-danger remove-btn" data-idx="${i}">&times;</button>
                </div>
            `);
        });
        draw();
    }

    // --- LÓGICA DE GIRO (TRUCADA) ---
    let currentRotation = 0; // Guardamos la rotación actual para que no salte

    $('#btnSpin').click(function() {
        if (names.length === 0) return;

        // Desactivar botón durante el giro
        $(this).prop('disabled', true);

        // 1. Matemáticas para ganar SIEMPRE el índice 0
        const spins = 5; // Vueltas completas mínimas (hace que se vea rápido)
        const sliceDegrees = 360 / names.length;
        
        // El índice 0 se dibuja empezando a las 12 en punto (-90 grados en canvas, 0 grados visuales CSS).
        // Abarca desde 0 grados hasta +sliceDegrees (en sentido horario).
        // Su CENTRO está en: sliceDegrees / 2.
        // Para que el centro quede bajo la flecha (que está en 0 grados visuales),
        // tenemos que rotar la ruleta hacia atrás (anti-horario) esa cantidad.
        
        const targetWedgeCenter = sliceDegrees / 2; 
        
        // Añadimos un poco de aleatoriedad (jitter) para que no caiga siempre EN EL MISMO PIXEL
        // pero asegurando que no se salga del sector ganador.
        // Margen de seguridad del 20% en cada lado.
        const margin = sliceDegrees * 0.2;
        const randomOffset = (Math.random() * (sliceDegrees - margin * 2)) - (sliceDegrees / 2 - margin);
        
        // Fórmula Mágica:
        // Queremos llegar a -(targetWedgeCenter).
        // Sumamos vueltas completas (360 * spins).
        // Restamos la posición actual modulada para suavizar transiciones si ya giró antes.
        
        const baseTarget = -(targetWedgeCenter) + randomOffset;
        const totalDegrees = (360 * spins) + baseTarget;
        
        // Ajustamos respecto a donde ya estamos para seguir girando hacia adelante
        // Esto evita que la ruleta gire "hacia atrás" si reiniciamos
        const finalRotation = currentRotation + totalDegrees + (360 - (currentRotation % 360));

        // 2. Aplicar CSS
        wheelBox.style.transition = "transform 6s cubic-bezier(0.2, 0.8, 0.1, 1)"; // Efecto frenado realista
        wheelBox.style.transform = `rotate(${finalRotation}deg)`;
        
        currentRotation = finalRotation; // Actualizar estado

        // 3. Mostrar ganador al terminar
        setTimeout(() => {
            $('#winnerText').text(names[0]); // Siempre gana el 0
            winnerModal.show();
            $('#btnSpin').prop('disabled', false);
            
            // Efecto de confeti simple (opcional visual)
            createConfetti();
        }, 6000); // 6s coincide con la transición CSS
    });

    // --- MANEJO DE EVENTOS ---
    $('#btnAdd').click(() => {
        const val = $('#inputName').val().trim();
        if(val) { names.push(val); $('#inputName').val(''); renderList(); }
    });
    
    $('#inputName').keypress((e) => {
        if(e.which === 13) $('#btnAdd').click();
    });

    $(document).on('click', '.remove-btn', function() {
        const idx = $(this).data('idx');
        names.splice(idx, 1);
        renderList();
    });

    $('#btnReset').click(() => {
        names = [];
        renderList();
        wheelBox.style.transition = 'none';
        wheelBox.style.transform = 'rotate(0deg)';
        currentRotation = 0;
    });

    // Efecto Confeti simple
    function createConfetti() {
        // Solo lógica visual extra, no afecta la ruleta
    }

    // Inicializar
    renderList();

</script>
</body>
</html>